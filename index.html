<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS Don Dionisio</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --color-principal: #d84315;
      --color-fondo: #fafafa;
      --color-primario-claro: #fff3e0;
      --color-terciario: #ff5722;
      --color-texto: #333;
      --sidebar-width: 200px;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      background: var(--color-fondo);
      color: var(--color-texto);
      min-height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: var(--sidebar-width);
      background: var(--color-primario-claro);
      border-right: 2px solid var(--color-principal);
      display: flex;
      flex-direction: column;
    }
    .sidebar .tab {
      padding: 15px;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 1px solid #ffccbc;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--color-principal);
      transition: background .3s;
    }
    .sidebar .tab:hover {
      background: rgba(216, 67, 21, 0.1);
    }
    .sidebar .tab.active {
      background: #fff;
      border-left: 4px solid var(--color-principal);
    }
    .sidebar .tab i {
      font-size: 1.2rem;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: var(--color-principal);
      color: #fff;
      padding: 15px 20px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
    }
    header h1 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.8rem;
    }
    .content {
      display: none;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }
    .content.active {
      display: block;
    }
    /* Nuevo Pedido sub-tabs */
    .sub-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      background: var(--color-primario-claro);
      padding: 10px;
      border-radius: 8px;
    }
    .sub-tab {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      background: white;
      color: var(--color-principal);
      font-weight: 600;
      transition: all 0.3s;
      border: 1px solid #ffccbc;
    }
    .sub-tab:hover {
      background: #ffccbc;
    }
    .sub-tab.active {
      background: var(--color-principal);
      color: #fff;
      border-color: var(--color-principal);
    }
    .sub-content {
      display: none;
    }
    .sub-content.active {
      display: block;
    }
    .add-btn {
      background: var(--color-terciario);
      color:#fff;
      border:none;
      padding:8px 15px;
      border-radius:4px;
      cursor:pointer;
      transition: background 0.3s;
      font-weight: 600;
    }
    .add-btn:hover {
      background: #e64a19;
    }
    .preview, #stats {
      background: var(--color-primario-claro);
      padding:20px;
      border-radius:8px;
      margin-bottom:20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    /* MEJORAS PARA EL MENÚ - Nuevo diseño */
    .menu-container {
      display: flex;
      flex-direction: row;
      gap: 20px;
      height: calc(100vh - 200px);
    }
    @media (max-width: 900px) {
      .menu-container {
        flex-direction: column;
      }
    }
    .menu-content {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      overflow-y: auto;
      padding-right: 10px;
      max-height: 100%;
      flex: 1;
    }
    .menu-content::-webkit-scrollbar {
      width: 8px;
    }
    .menu-content::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .menu-content::-webkit-scrollbar-thumb {
      background: #bdbdbd;
      border-radius: 4px;
    }
    .menu-content::-webkit-scrollbar-thumb:hover {
      background: #9e9e9e;
    }
    .category-item {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .category-header {
      background: var(--color-principal);
      color: white;
      padding: 12px 15px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .category-content {
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      display: block; /* Cambiado para mostrar inicialmente */
    }
    .product-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .product-item:hover {
      background: #fff3e0;
    }
    .product-item:last-child {
      border-bottom: none;
    }
    .product-name {
      font-weight: 500;
      flex: 1;
    }
    .product-price {
      color: var(--color-principal);
      font-weight: bold;
      margin-left: 10px;
    }
    .product-options {
      margin-top: 10px;
      padding: 10px;
      background: #fff8f3;
      border-radius: 6px;
      font-size: 0.9em;
    }
    .option-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .option-label {
      flex: 1;
      font-weight: 500;
    }
    .option-control {
      width: 150px;
    }
    .order-form {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
      margin-top: 15px;
    }
    .order-form input, .order-form select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    #previewList {
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
      list-style: none;
    }
    #previewList li {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    #previewTotal {
      font-weight: bold;
      font-size: 1.3em;
      text-align: right;
      padding: 10px 0;
      color: var(--color-principal);
    }
    
    /* Estilos para pedidos */
    .orders-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .order-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .order-products div {
      padding: 5px 0;
      display: flex;
      justify-content: space-between;
    }
    .order-total {
      border-top: 1px solid #eee;
      padding-top: 10px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .order-info {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }
    
    /* Gestión de productos */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: var(--color-primario-claro);
      color: var(--color-principal);
      font-weight: 600;
    }
    tr:hover {
      background-color: rgba(216, 67, 21, 0.05);
    }
    .input-inline {
      width: 80px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .remove-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      margin-top: 20px;
    }
    
    /* Botón cerrar día */
    .close-day {
      background: #4caf50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 20px;
      display: block;
      margin-left: auto;
    }
    .close-day:hover {
      background: #388e3c;
    }
    
    /* Ticket de impresión - Nuevo diseño */
    .ticket-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .ticket-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      width: 300px;
      max-width: 90%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      text-align: center;
      font-family: monospace;
    }
    .ticket-header {
      text-align: center;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .ticket-header h1 {
      font-size: 32px;
      color: #000;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .ticket-header h2 {
      font-size: 24px;
      color: #000;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .ticket-info {
      margin: 15px 0;
      font-size: 16px;
      color: #000;
      text-align: left;
    }
    .ticket-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    .ticket-table th {
      border-bottom: 2px solid #000;
      padding: 8px 0;
      text-align: left;
      font-weight: bold;
    }
    .ticket-table td {
      padding: 6px 0;
      border-bottom: 1px solid #ddd;
    }
    .ticket-total {
      font-weight: bold;
      font-size: 20px;
      text-align: right;
      margin: 20px 0;
      border-top: 2px solid #000;
      padding-top: 10px;
    }
    .ticket-address {
      font-size: 16px;
      font-weight: bold;
      margin: 20px 0;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 5px;
      text-align: left;
    }
    .ticket-actions {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
    .ticket-actions button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #printTicket {
      background: #4caf50;
      color: white;
    }
    #closeTicket {
      background: #f44336;
      color: white;
    }
    
    /* Control de caja */
    .caja-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .caja-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 200px;
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
    }
    .caja-section h3 {
      color: var(--color-principal);
      margin-bottom: 15px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    #totalEfectivo, #totalCaja, #totalVentas, #totalMercadoPago {
      font-size: 1.8em;
      font-weight: bold;
      text-align: center;
      color: #2E7D32;
      margin: 10px 0;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #gastosList {
      max-height: 200px;
      overflow-y: auto;
      margin: 15px 0;
      flex: 1;
    }
    .gasto-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .gasto-item button {
      background: #f44336;
      color: white;
      border: none;
      padding: 2px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .form-gasto {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      margin-top: 15px;
    }
    .form-gasto input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* Nuevos estilos para vista previa */
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .empty-preview {
      text-align: center;
      color: #888;
      padding: 20px;
      font-style: italic;
    }
    .preview-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .preview-item .item-time {
      font-size: 0.8em;
      color: #888;
    }
    .preview-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .preview-actions button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    #clearOrder {
      background: #f5f5f5;
      color: #333;
    }
    #clearOrder:hover {
      background: #e0e0e0;
    }
    
    /* Secciones adicionales para caja */
    .caja-ventas-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    
    /* Estilos para impresión de dos tickets */
    @media print {
      body * {
        visibility: hidden;
      }
      .ticket-container, .ticket-container * {
        visibility: visible;
      }
      .ticket-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-around;
        background: white;
      }
      .ticket-content {
        box-shadow: none;
        margin: 0 10px;
        width: 45%;
      }
    }
    
    /* Compatibilidad para Windows 7 Chrome */
    .compatibility-warning {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #ff9800;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 2000;
    }
    
    /* Logo para mejor identificación */
    .logo-container {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .logo {
      width: 60px;
      height: 60px;
      background: var(--color-principal);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
      margin-right: 15px;
    }
  </style>
</head>
<body>
  <div class="compatibility-warning" id="compatibilityWarning">
    <i class="fas fa-exclamation-triangle"></i> Estás usando una versión antigua de navegador. Algunas funciones pueden verse limitadas.
  </div>
  
  <div class="sidebar">
    <div class="tab active" data-target="nuevo"><i class="fas fa-plus-circle"></i> Nuevo Pedido</div>
    <div class="tab" data-target="gestion"><i class="fas fa-cogs"></i> Gestión Productos</div>
    <div class="tab" data-target="resumen"><i class="fas fa-cash-register"></i> Control de Caja</div>
  </div>
  
  <div class="main">
    <header>
      <div class="logo-container">
        <div class="logo">DD</div>
        <h1><i class="fas fa-pizza-slice"></i> POS - PIZZERIA DON DIONISIO</h1>
      </div>
      <p>Sistema de gestión de pedidos y ventas</p>
    </header>
    
    <!-- NUEVO PEDIDO -->
    <div id="nuevo" class="content active">
      <div class="sub-tabs">
        <div class="sub-tab active" data-sub="menu">Menú</div>
        <div class="sub-tab" data-sub="cocina">Cocina</div>
        <div class="sub-tab" data-sub="camino">En Camino</div>
        <div class="sub-tab" data-sub="finalizado">Entregados</div>
      </div>
      
      <!-- Menú Pedidos -->
      <div id="menu" class="sub-content active">
        <div class="menu-container">
          <div class="menu-content">
            <!-- Pizzas -->
            <div class="category-item">
              <div class="category-header" data-cat="pizzas">
                <span>Pizzas</span>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="category-content" id="pizzasList"></div>
            </div>
            
            <!-- Hamburguesas -->
            <div class="category-item">
              <div class="category-header" data-cat="hamburguesas">
                <span>Hamburguesas</span>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="category-content" id="hamburguesasList"></div>
            </div>
            
            <!-- Sándwiches de Milanesa -->
            <div class="category-item">
              <div class="category-header" data-cat="sandwiches">
                <span>Sándwiches</span>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="category-content" id="sandwichesList"></div>
            </div>
            
            <!-- Empanadas -->
            <div class="category-item">
              <div class="category-header" data-cat="empanadas">
                <span>Empanadas</span>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="category-content" id="empanadasList"></div>
            </div>
            
            <!-- Minutas -->
            <div class="category-item">
              <div class="category-header" data-cat="minutas">
                <span>Minutas</span>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="category-content" id="minutasList"></div>
            </div>
          </div>
          
          <div class="preview">
            <div class="preview-header">
              <h3><i class="fas fa-shopping-cart"></i> Vista Previa del Pedido</h3>
              <span id="itemsCount">0 items</span>
            </div>
            
            <div id="previewContainer">
              <div class="empty-preview">No hay productos en el pedido</div>
              <ul id="previewList" style="display: none;"></ul>
            </div>
            
            <p id="previewTotal" style="display: none;">Total: $0</p>
            
            <div class="order-form">
              <input type="text" id="dir" placeholder="Dirección de entrega">
              <select id="mpago">
                <option value="efectivo">Efectivo</option>
                <option value="mercadopago">MercadoPago</option>
              </select>
              <button class="add-btn" id="finalizar">Finalizar Pedido</button>
            </div>
            
            <div class="preview-actions">
              <button id="clearOrder">Vaciar Pedido</button>
              <button id="showDetail" style="display: none;">Ver Detalle</button>
            </div>
            
            <div id="productDetail" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <h3>Detalle del Producto</h3>
              <div id="detailContent"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Cocina -->
      <div id="cocina" class="sub-content">
        <h3><i class="fas fa-utensils"></i> Pedidos en Cocina</h3>
        <div class="orders-container" id="cocinaList"></div>
      </div>
      
      <!-- En Camino -->
      <div id="camino" class="sub-content">
        <h3><i class="fas fa-motorcycle"></i> Pedidos en Camino</h3>
        <div class="orders-container" id="caminoList"></div>
      </div>
      
      <!-- Finalizados -->
      <div id="finalizado" class="sub-content">
        <h3><i class="fas fa-check-circle"></i> Pedidos Entregados</h3>
        <div class="orders-container" id="finalizadoList"></div>
      </div>
    </div>
    
    <!-- GESTIÓN PRODUCTOS -->
    <div id="gestion" class="content">
      <h2><i class="fas fa-box-open"></i> Gestión de Productos</h2>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Precio</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="prodBody"></tbody>
      </table>
      
      <div class="form-grid">
        <input id="newName" placeholder="Nombre del producto" style="padding:10px;">
        <select id="newTipo" style="padding:10px;">
          <option value="pizzas">Pizza</option>
          <option value="hamburguesas">Hamburguesa</option>
          <option value="sandwiches">Sándwich</option>
          <option value="empanadas">Empanada</option>
          <option value="minutas">Minuta</option>
        </select>
        <input id="newPrice" type="number" placeholder="Precio" style="padding:10px;">
        <button class="add-btn" id="addProd">Agregar</button>
      </div>
    </div>
    
    <!-- CONTROL DE CAJA -->
    <div id="resumen" class="content">
      <h2><i class="fas fa-cash-register"></i> Control de Caja</h2>
      
      <div class="caja-container">
        <div class="caja-section">
          <h3>Total en Efectivo</h3>
          <p id="totalEfectivo">$0</p>
        </div>
        
        <div class="caja-section">
          <h3>Gastos</h3>
          <div id="gastosList"></div>
          <div class="form-gasto">
            <input type="text" id="gastoDesc" placeholder="Descripción">
            <input type="number" id="gastoMonto" placeholder="Monto">
            <button class="add-btn" id="addGasto">Agregar</button>
          </div>
        </div>
        
        <div class="caja-section">
          <h3>Total Caja</h3>
          <p id="totalCaja">$0</p>
        </div>
      </div>
      
      <div class="caja-ventas-container">
        <div class="caja-section">
          <h3>Total de Ventas</h3>
          <p id="totalVentas">$0</p>
        </div>
        
        <div class="caja-section">
          <h3>Total en MercadoPago</h3>
          <p id="totalMercadoPago">$0</p>
        </div>
      </div>
      
      <button class="close-day" id="closeDay">Cerrar Día y Exportar Excel</button>
    </div>
  </div>
  
  <!-- Ticket de impresión - Nuevo diseño -->
  <div class="ticket-container" id="ticketContainer">
    <div class="ticket-content">
      <div class="ticket-header">
        <h1>DON</h1>
        <h1>DIONISIO</h1>
      </div>
      
      <div class="ticket-info">
        <p><strong>Dirección de entrega:</strong></p>
        <p><span id="ticketAddress"></span></p>
      </div>
      
      <table class="ticket-table">
        <thead>
          <tr>
            <th>DETALLE</th>
            <th style="text-align: right;">PRECIO</th>
          </tr>
        </thead>
        <tbody id="ticketItems"></tbody>
      </table>
      
      <div class="ticket-total">
        TOTAL: $<span id="ticketTotal"></span>
      </div>
      
      <div class="ticket-actions">
        <button id="printTicket"><i class="fas fa-print"></i> Imprimir</button>
        <button id="closeTicket"><i class="fas fa-times"></i> Cerrar</button>
      </div>
    </div>
  </div>
  
  <script>
    // Polyfills para compatibilidad con navegadores antiguos
    if (!Array.prototype.forEach) {
      Array.prototype.forEach = function(callback) {
        for (var i = 0; i < this.length; i++) {
          callback(this[i], i, this);
        }
      };
    }
    
    if (!Array.prototype.filter) {
      Array.prototype.filter = function(callback) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          if (callback(this[i], i, this)) {
            result.push(this[i]);
          }
        }
        return result;
      };
    }
    
    if (!Array.prototype.map) {
      Array.prototype.map = function(callback) {
        var result = [];
        for (var i = 0; i < this.length; i++) {
          result.push(callback(this[i], i, this));
        }
        return result;
      };
    }
    
    if (!Array.prototype.reduce) {
      Array.prototype.reduce = function(callback, initialValue) {
        var accumulator = initialValue === undefined ? this[0] : initialValue;
        var startIndex = initialValue === undefined ? 1 : 0;
        
        for (var i = startIndex; i < this.length; i++) {
          accumulator = callback(accumulator, this[i], i, this);
        }
        return accumulator;
      };
    }
    
    if (!Array.prototype.find) {
      Array.prototype.find = function(predicate) {
        for (var i = 0; i < this.length; i++) {
          if (predicate(this[i], i, this)) {
            return this[i];
          }
        }
        return undefined;
      };
    }
    
    if (!Element.prototype.closest) {
      Element.prototype.closest = function(s) {
        var el = this;
        do {
          if (el.matches(s)) return el;
          el = el.parentElement || el.parentNode;
        } while (el !== null && el.nodeType === 1);
        return null;
      };
    }
    
    if (!Element.prototype.matches) {
      Element.prototype.matches = 
        Element.prototype.matchesSelector || 
        Element.prototype.mozMatchesSelector ||
        Element.prototype.msMatchesSelector || 
        Element.prototype.oMatchesSelector || 
        Element.prototype.webkitMatchesSelector ||
        function(s) {
          var matches = (this.document || this.ownerDocument).querySelectorAll(s),
            i = matches.length;
          while (--i >= 0 && matches.item(i) !== this) {}
          return i > -1;            
        };
    }
    
    // Detectar navegadores antiguos
    function detectOldBrowser() {
      var ua = navigator.userAgent;
      var isIE = ua.indexOf('MSIE ') > -1 || ua.indexOf('Trident/') > -1;
      var isOldChrome = ua.indexOf('Chrome/') > -1 && parseInt(ua.split('Chrome/')[1].split('.')[0]) < 50;
      
      if (isIE || isOldChrome) {
        document.getElementById('compatibilityWarning').style.display = 'block';
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      detectOldBrowser();
      
      // Nuevo menú extraído de las imágenes
      var menu = {
        PIZZAS: [
          "Muzzarela",
          "Fugazzeta",
          "Napolitana",
          "Jamón y Morrones",
          "Huevo",
          "Calabresa",
          "Primavera",
          "Ranchera",
          "Fugazzeta Especial",
          "Ranchera Panceta",
          "Cuatro Quesos",
          "Roquefort",
          "Palmitos",
          "Vienesa",
          "Vienesa Especial",
          "Papas con Cheddar",
          "Napolitana Especial",
          "Barrilete"
        ],
        HAMBURGUESAS: [
          "Opción Uno (Simple)",
          "Opción Uno (Doble)",
          "Opción Dos (Simple)",
          "Opción Dos (Doble)",
          "Combo 5 Hamburguesas"
        ],
        SANDWICHES: [
          "XL Completo",
          "XL Napolitano",
          "XL Ranchero",
          "Individual Completo",
          "Individual Napolitano"
        ],
        EMPANADAS: [
          "Carne",
          "Pollo",
          "Jamón y Queso"
        ],
        MINUTAS: [
          "Milanesa Napolitana",
          "Milanesa a Caballo",
          "Porción de Papas Fritas",
          "Papas con Cheddar",
          "Papas con Cheddar y Panceta"
        ]
      };

      // Precios por defecto para los nuevos productos
      var defaultPrices = {
        // Pizzas
        "Muzzarela": 8000,
        "Fugazzeta": 9500,
        "Napolitana": 9500,
        "Jamón y Morrones": 9500,
        "Huevo": 9500,
        "Calabresa": 9500,
        "Primavera": 10000,
        "Ranchera": 10000,
        "Fugazzeta Especial": 10000,
        "Ranchera Panceta": 11000,
        "Cuatro Quesos": 10500,
        "Roquefort": 10500,
        "Palmitos": 10500,
        "Vienesa": 10000,
        "Vienesa Especial": 11000,
        "Papas con Cheddar": 11000,
        "Napolitana Especial": 10000,
        "Barrilete": 12000,
        
        // Hamburguesas
        "Opción Uno (Simple)": 6500,
        "Opción Uno (Doble)": 8500,
        "Opción Dos (Simple)": 6500,
        "Opción Dos (Doble)": 8500,
        "Combo 5 Hamburguesas": 14000,
        
        // Sándwiches
        "XL Completo": 12000,
        "XL Napolitano": 12000,
        "XL Ranchero": 12000,
        "Individual Completo": 7000,
        "Individual Napolitano": 7000,
        
        // Empanadas
        "Carne": 1000,
        "Pollo": 1000,
        "Jamón y Queso": 1000,
        
        // Minutas
        "Milanesa Napolitana": 7000,
        "Milanesa a Caballo": 7000,
        "Porción de Papas Fritas": 3000,
        "Papas con Cheddar": 3700,
        "Papas con Cheddar y Panceta": 4000
      };

      // Convertir el menú en array de productos
      var productos = [];
      Object.keys(menu).forEach(function(tipo) {
        menu[tipo].forEach(function(nombre) {
          productos.push({
            id: Date.now() + Math.random(),
            nombre: nombre,
            tipo: tipo.toLowerCase(),
            precio: defaultPrices[nombre] || 0
          });
        });
      });

      var pedidos = [], pid = 1, currentOrder = [];
      var gastos = [];

      // Almacenamiento temporal en localStorage
      function guardarDatosTemporales() {
        var datosDia = {
          productos: productos,
          pedidos: pedidos,
          pid: pid,
          gastos: gastos
        };
        localStorage.setItem('datosDia', JSON.stringify(datosDia));
      }

      // Cargar datos al iniciar (si existen)
      function cargarDatosTemporales() {
        var datosGuardados = localStorage.getItem('datosDia');
        return datosGuardados ? JSON.parse(datosGuardados) : null;
      }

      // Función "Cerrar día"
      function cerrarDia() {
        var ent = pedidos.filter(function(o) { return o.estado === 'finalizado'; });
        if(ent.length === 0) {
          alert('No hay pedidos entregados hoy');
          return;
        }

        // Prepare data for Excel
        var data = ent.map(function(order) {
          var items = order.items.map(function(item) { return item.desc; }).join('; ');
          var total = order.items.reduce(function(s, i) { return s + i.precio; }, 0);
          
          return {
            'ID Pedido': order.id,
            'Dirección': order.dir,
            'Método de Pago': order.pago === 'efectivo' ? 'Efectivo' : 'MercadoPago',
            'Productos': items,
            'Total': total,
            'Hora': order.hora,
            'Fecha': new Date().toLocaleDateString('es-ES')
          };
        });

        // Create worksheet
        var ws = XLSX.utils.json_to_sheet(data);

        // Create workbook
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pedidos");

        // Generate file and download
        var dateStr = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, 'Pedidos_DonDionisio_' + dateStr + '.xlsx');

        alert('Se ha generado el archivo Excel con ' + ent.length + ' pedidos');
        
        // Borrar datos del localStorage
        localStorage.removeItem('datosDia');
        
        // Reiniciar variables
        pedidos = [];
        pid = 1;
        gastos = [];
        
        // Actualizar UI
        renderSubLists();
        renderCaja();
      }

      // Cargar datos iniciales
      var datosIniciales = cargarDatosTemporales();
      if (datosIniciales) {
        productos = datosIniciales.productos || productos;
        pedidos = datosIniciales.pedidos || [];
        pid = datosIniciales.pid || pid;
        gastos = datosIniciales.gastos || [];
      }

      // Sidebar navigation
      var tabs = document.querySelectorAll('.sidebar .tab');
      tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          tabs.forEach(function(t) { t.classList.remove('active'); });
          document.querySelectorAll('.content').forEach(function(c) { c.classList.remove('active'); });
          tab.classList.add('active');
          var target = tab.getAttribute('data-target');
          document.getElementById(target).classList.add('active');
          
          if (target === 'resumen') {
            renderCaja();
          } else if (target === 'gestion') {
            renderManagement();
          } else if (target === 'nuevo') {
            renderCategories();
            renderSubLists();
          }
        });
      });

      // Sub-tabs navigation
      var stabs = document.querySelectorAll('.sub-tab');
      stabs.forEach(function(st) {
        st.addEventListener('click', function() {
          stabs.forEach(function(s) { s.classList.remove('active'); });
          document.querySelectorAll('.sub-content').forEach(function(sc) { sc.classList.remove('active'); });
          st.classList.add('active');
          var subTarget = st.getAttribute('data-sub');
          document.getElementById(subTarget).classList.add('active');
          if (subTarget === 'menu') {
            renderCategories();
          } else {
            renderSubLists();
          }
        });
      });

      // Render categories with scrollable lists
      function renderCategories() {
        var categories = ['pizzas', 'hamburguesas', 'sandwiches', 'empanadas', 'minutas'];
        
        categories.forEach(function(cat) {
          var list = document.getElementById(cat + 'List');
          if (list) {
            list.innerHTML = '';
            var catProducts = productos.filter(function(p) { return p.tipo === cat; });
            
            if (catProducts.length === 0) {
              list.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">No hay productos en esta categoría</div>';
            } else {
              catProducts.forEach(function(p) {
                var item = document.createElement('div');
                item.className = 'product-item';
                item.dataset.id = p.id;
                item.innerHTML = '<div class="product-name">' + p.nombre + '</div>' +
                                 '<div class="product-price">$' + p.precio + '</div>';
                list.appendChild(item);
                
                item.addEventListener('click', function() {
                  showProductDetail(p);
                });
              });
            }
          }
        });
      }
      
      // Show product details and options
      function showProductDetail(p) {
        var detailContent = document.getElementById('detailContent');
        detailContent.innerHTML = '';
        
        var optionsHTML = '';
        if(p.tipo === 'pizzas') {
          var options = productos.filter(function(o) { return o.tipo === 'pizzas' && o.id !== p.id; })
                          .map(function(o) { return '<option value="' + o.id + '">' + o.nombre + '</option>'; })
                          .join('');
          
          optionsHTML = '<div class="product-options">' +
                          '<h4>Opciones de Pizza</h4>' +
                          '<div class="option-row">' +
                            '<div class="option-label">Mitad:</div>' +
                            '<div class="option-control">' +
                              '<select class="half-select" data-id="' + p.id + '" style="width:100%; padding:8px;">' +
                                '<option value="">-- No --</option>' + options +
                              '</select>' +
                            '</div>' +
                          '</div>' +
                        '</div>';
        } else if(p.tipo === 'sandwiches') {
          optionsHTML = '<div class="product-options">' +
                          '<h4>Opciones de Sándwich</h4>' +
                          '<div class="option-row">' +
                            '<div class="option-label">Papas Fritas:</div>' +
                            '<div class="option-control">' +
                              '<input type="checkbox" class="papas-checkbox" data-id="' + p.id + '"> +$1000' +
                            '</div>' +
                          '</div>' +
                        '</div>';
        }
        
        detailContent.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">' +
                                    '<h3 style="margin:0;">' + p.nombre + '</h3>' +
                                    '<div style="font-size: 1.3em; font-weight: bold; color: var(--color-principal);">$' + p.precio + '</div>' +
                                  '</div>' +
                                  '<p style="margin-bottom: 15px; color:#666;">' + 
                                    (p.tipo === 'pizzas' ? 'Pizza clásica con ingredientes frescos' : 
                                     p.tipo === 'sandwiches' ? 'Sándwich artesanal' : 
                                     p.tipo === 'hamburguesas' ? 'Hamburguesa gourmet' : 
                                     p.tipo === 'empanadas' ? 'Empanada casera' : 'Minuta del día') +
                                  '</p>' +
                                  optionsHTML +
                                  '<div style="text-align: center; margin-top: 20px;">' +
                                    '<button class="add-btn" style="padding: 12px 25px; font-size: 1.1em;" data-id="' + p.id + '" id="addToOrderBtn">Agregar al Pedido</button>' +
                                  '</div>';
        
        document.getElementById('productDetail').style.display = 'block';
        
        document.getElementById('addToOrderBtn').addEventListener('click', function() {
          addToOrder(p);
        });
      }
      
      // Add product to current order
      function addToOrder(prod) {
        var precio = prod.precio;
        var desc = prod.nombre;
        
        if(prod.tipo === 'pizzas') {
          var sel = document.querySelector('.half-select[data-id="' + prod.id + '"]');
          if(sel && sel.value) {
            var o = productos.find(function(x) { return x.id == sel.value; });
            precio = Math.max(prod.precio, o.precio);
            desc += ' (mitad ' + o.nombre + ')';
          }
        }
        
        if(prod.tipo === 'sandwiches') {
          var checkbox = document.querySelector('.papas-checkbox[data-id="' + prod.id + '"]');
          if(checkbox && checkbox.checked) {
            precio += 1000;
            desc += ' + Papas';
          }
        }
        
        var hora = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        currentOrder.push({desc: desc, precio: precio, hora: hora});
        updatePreview();
        
        document.getElementById('productDetail').style.display = 'none';
      }
      
      // Update order preview
      function updatePreview() {
        var list = document.getElementById('previewList');
        list.innerHTML = '';
        var sum = 0;
        
        if(currentOrder.length === 0) {
          document.querySelector('#previewContainer .empty-preview').style.display = 'block';
          list.style.display = 'none';
          document.getElementById('previewTotal').style.display = 'none';
          document.getElementById('showDetail').style.display = 'none';
        } else {
          document.querySelector('#previewContainer .empty-preview').style.display = 'none';
          list.style.display = 'block';
          document.getElementById('previewTotal').style.display = 'block';
          document.getElementById('showDetail').style.display = 'block';
          
          currentOrder.forEach(function(i) {
            list.innerHTML += '<li>' +
                                '<span>' + i.desc + '</span>' +
                                '<span>$' + i.precio + ' <span class="order-time" style="font-size:0.8em; color:#888;">(' + i.hora + ')</span></span>' +
                              '</li>';
            sum += i.precio;
          });
        }
        
        document.getElementById('previewTotal').innerText = 'Total: $' + sum;
        document.getElementById('itemsCount').innerText = currentOrder.length + ' ' + (currentOrder.length === 1 ? 'item' : 'items');
      }
      
      // Vaciar pedido actual
      document.getElementById('clearOrder').addEventListener('click', function() {
        currentOrder = [];
        updatePreview();
      });
      
      // Finalize order and generate ticket
      document.getElementById('finalizar').addEventListener('click', function() {
        var dir = document.getElementById('dir').value;
        var pago = document.getElementById('mpago').value;
        
        if(!dir || currentOrder.length === 0) {
          alert('Por favor ingrese una dirección y agregue productos al pedido');
          return;
        }
        
        pedidos.push({
          id: pid++,
          items: currentOrder.slice(),
          dir: dir,
          pago: pago,
          estado: 'cocina',
          hora: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });
        
        // Show ticket
        showTicket(pedidos[pedidos.length - 1]);
        
        currentOrder = [];
        updatePreview();
        renderSubLists();
        renderCaja();
        
        document.getElementById('dir').value = '';
        
        // Guardar en localStorage
        guardarDatosTemporales();
      });
      
      // Show ticket for printing
      function showTicket(order) {
        var total = order.items.reduce(function(sum, item) { return sum + item.precio; }, 0);
        
        document.getElementById('ticketAddress').textContent = order.dir;
        
        var ticketItems = document.getElementById('ticketItems');
        ticketItems.innerHTML = '';
        order.items.forEach(function(item) {
          ticketItems.innerHTML += '<tr>' +
                                     '<td>' + item.desc + '</td>' +
                                     '<td style="text-align: right;">$' + item.precio.toFixed(2) + '</td>' +
                                   '</tr>';
        });
        
        document.getElementById('ticketTotal').textContent = total.toFixed(2);
        document.getElementById('ticketContainer').style.display = 'flex';
      }
      
      // Print ticket
      document.getElementById('printTicket').addEventListener('click', function() {
        window.print();
      });
      
      // Close ticket
      document.getElementById('closeTicket').addEventListener('click', function() {
        document.getElementById('ticketContainer').style.display = 'none';
      });
      
      // Render orders in different status
      function renderSubLists() {
        ['cocina','camino','finalizado'].forEach(function(e) {
          var cont = document.getElementById(e + 'List');
          cont.innerHTML = '';
          
          var orders = pedidos.filter(function(o) { return o.estado === e; });
          
          if(orders.length === 0) {
            cont.innerHTML = '<div style="text-align:center; padding:30px; color:#888; background:white; border-radius:8px;">' +
                               '<i class="fas fa-inbox" style="font-size:3em; margin-bottom:15px;"></i>' +
                               '<p>No hay pedidos en esta categoría</p>' +
                             '</div>';
            return;
          }
          
          orders.forEach(function(o) {
            var card = document.createElement('div');
            card.className = 'order-card';
            
            var total = o.items.reduce(function(sum, item) { return sum + item.precio; }, 0);
            
            var itemsHTML = o.items.map(function(it) {
              return '<div><span>' + it.desc + '</span><span>$' + it.precio + '</span></div>';
            }).join('');
            
            card.innerHTML = '<div class="order-header">' +
                               '<div style="font-weight: bold; color: var(--color-principal);">#' + o.id + '</div>' +
                               '<div class="order-time" style="color:#666;">' + o.hora + '</div>' +
                             '</div>' +
                             '<div class="order-products">' + itemsHTML + '</div>' +
                             '<div class="order-total">' +
                               '<span>Total:</span>' +
                               '<span>$' + total + '</span>' +
                             '</div>' +
                             '<div class="order-info">' +
                               '<div><strong>Dirección:</strong> ' + o.dir + '</div>' +
                               '<div><strong>Pago:</strong> ' + (o.pago === 'efectivo' ? 'Efectivo' : 'MercadoPago') + '</div>' +
                             '</div>';
            
            if(e !== 'finalizado') {
              var btn = document.createElement('button');
              btn.className = 'add-btn';
              btn.style.width = '100%';
              btn.style.marginTop = '15px';
              btn.innerText = e === 'cocina' ? 'Enviar a Entrega' : 'Marcar como Entregado';
              
              btn.addEventListener('click', function() {
                o.estado = e === 'cocina' ? 'camino' : 'finalizado';
                renderSubLists();
                renderCaja();
                guardarDatosTemporales();
              });
              
              card.appendChild(btn);
            }
            
            cont.appendChild(card);
          });
        });
      }
      
      // Product management
      function renderManagement() {
        var tbody = document.getElementById('prodBody');
        tbody.innerHTML = '';
        
        productos.forEach(function(p) {
          var tr = document.createElement('tr');
          tr.innerHTML = '<td>' + p.nombre + '</td>' +
                         '<td>' + p.tipo + '</td>' +
                         '<td>' +
                           '<input type="number" value="' + p.precio + '" data-id="' + p.id + '" ' +
                           'class="input-inline edit-price" style="width: 100px; padding: 8px;">' +
                         '</td>' +
                         '<td>' +
                           '<button class="remove-btn" data-id="' + p.id + '">' +
                             '<i class="fas fa-trash"></i> Eliminar' +
                           '</button>' +
                         '</td>';
          tbody.appendChild(tr);
        });
        
        document.querySelectorAll('.edit-price').forEach(function(inp) {
          inp.addEventListener('change', function() {
            var prod = productos.find(function(x) { return x.id == inp.dataset.id; });
            if(prod) {
              prod.precio = Number(inp.value);
              renderCategories();
              guardarDatosTemporales();
            }
          });
        });
        
        document.querySelectorAll('.remove-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            productos = productos.filter(function(x) { return x.id != btn.dataset.id; });
            renderManagement();
            renderCategories();
            guardarDatosTemporales();
          });
        });
      }
      
      // Add new product
      document.getElementById('addProd').addEventListener('click', function() {
        var n = document.getElementById('newName').value;
        var t = document.getElementById('newTipo').value;
        var pr = Number(document.getElementById('newPrice').value);
        
        if(!n || pr <= 0) {
          alert('Por favor ingrese un nombre y precio válido');
          return;
        }
        
        productos.push({
          id: Date.now(),
          nombre: n,
          tipo: t,
          precio: pr
        });
        
        renderManagement();
        renderCategories();
        guardarDatosTemporales();
        
        document.getElementById('newName').value = '';
        document.getElementById('newPrice').value = '';
      });
      
      // Render caja control
      function renderCaja() {
        // Calcular efectivo (solo pedidos finalizados en efectivo)
        var efectivo = pedidos
          .filter(function(o) { return o.estado === 'finalizado' && o.pago === 'efectivo'; })
          .reduce(function(sum, o) { 
            return sum + o.items.reduce(function(s, i) { return s + i.precio; }, 0); 
          }, 0);
        
        // Calcular total gastos
        var totalGastos = gastos.reduce(function(sum, g) { return sum + g.monto; }, 0);
        
        // Calcular total caja
        var totalCaja = efectivo - totalGastos;
        
        // Calcular total de ventas (todos los pedidos entregados)
        var totalVentas = pedidos
          .filter(function(o) { return o.estado === 'finalizado'; })
          .reduce(function(sum, o) { 
            return sum + o.items.reduce(function(s, i) { return s + i.precio; }, 0); 
          }, 0);
        
        // Calcular total en MercadoPago
        var totalMercadoPago = pedidos
          .filter(function(o) { return o.estado === 'finalizado' && o.pago === 'mercadopago'; })
          .reduce(function(sum, o) { 
            return sum + o.items.reduce(function(s, i) { return s + i.precio; }, 0); 
          }, 0);
        
        // Actualizar UI
        document.getElementById('totalEfectivo').textContent = '$' + efectivo.toFixed(2);
        document.getElementById('totalCaja').textContent = '$' + totalCaja.toFixed(2);
        document.getElementById('totalVentas').textContent = '$' + totalVentas.toFixed(2);
        document.getElementById('totalMercadoPago').textContent = '$' + totalMercadoPago.toFixed(2);
        
        // Renderizar gastos
        var gastosList = document.getElementById('gastosList');
        gastosList.innerHTML = '';
        
        if(gastos.length === 0) {
          gastosList.innerHTML = '<p style="text-align:center; color:#888;">No hay gastos registrados</p>';
        } else {
          gastos.forEach(function(gasto, index) {
            var item = document.createElement('div');
            item.className = 'gasto-item';
            item.innerHTML = '<span>' + gasto.desc + '</span>' +
                             '<span>$' + gasto.monto.toFixed(2) + '</span>' +
                             '<button data-index="' + index + '"><i class="fas fa-trash"></i></button>';
            gastosList.appendChild(item);
            
            item.querySelector('button').addEventListener('click', function(e) {
              gastos.splice(index, 1);
              renderCaja();
              guardarDatosTemporales();
            });
          });
        }
      }
      
      // Agregar gasto
      document.getElementById('addGasto').addEventListener('click', function() {
        var desc = document.getElementById('gastoDesc').value;
        var monto = parseFloat(document.getElementById('gastoMonto').value);
        
        if(!desc || isNaN(monto)) {
          alert('Por favor complete la descripción y el monto');
          return;
        }
        
        gastos.push({
          desc: desc,
          monto: monto,
          fecha: new Date().toLocaleString()
        });
        
        document.getElementById('gastoDesc').value = '';
        document.getElementById('gastoMonto').value = '';
        
        renderCaja();
        guardarDatosTemporales();
      });
      
      // Close day and export to Excel
      document.getElementById('closeDay').addEventListener('click', cerrarDia);
      
      // Toggle category visibility
      document.addEventListener('click', function(e) {
        var header = e.target.closest('.category-header');
        if (header) {
          var content = header.nextElementSibling;
          var icon = header.querySelector('i');
          
          if(content.style.display === 'none') {
            content.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
          } else {
            content.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
          }
        }
      });

      // Initialize categories as expanded
      document.querySelectorAll('.category-content').forEach(function(content) {
        content.style.display = 'block';
      });
      document.querySelectorAll('.category-header i').forEach(function(icon) {
        icon.className = 'fas fa-chevron-up';
      });

      // Initialize
      renderCategories();
      updatePreview();
      renderSubLists();
      renderManagement();
      renderCaja();
    });
  </script>
</body>
</html>